/*!
 * Hesabe Apple Pay v1.0.0
 * Apple Pay integration library for Hesabe payment gateway
 * (c) 2025 Hesabe IT Team
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).HesabeApplePay=t()}(this,function(){"use strict";class e{static PAYMENT_TYPES={MPGS_APPLE_PAY:9,CYBERSOURCE_APPLE_PAY:10,KNET_DEBIT:11,KNET_CREDIT:12,KNET_INTERNATIONAL_APPLE_PAY:13,AMEX_APPLE_PAY:14};static APPLE_PAYMENT_METHOD_IDS=[e.PAYMENT_TYPES.MPGS_APPLE_PAY,e.PAYMENT_TYPES.CYBERSOURCE_APPLE_PAY,e.PAYMENT_TYPES.KNET_DEBIT,e.PAYMENT_TYPES.KNET_CREDIT,e.PAYMENT_TYPES.KNET_INTERNATIONAL_APPLE_PAY,e.PAYMENT_TYPES.AMEX_APPLE_PAY];static AP_DEFAULT_CARD={merchantCapabilities:["supports3DS"],supportedNetworks:["visa","masterCard"]};#e;#t;constructor(e={}){this.#e=this.#a(e),this.#t={routes:{appleValidation:this.#n()+"/transaction/apple",payment:this.#n()+"/payment"},token:this.#e.token},this.#i()}#a(e){const t={env:"sandbox",debug:!1,currencyCode:"KWD",countryCode:"KW",amount:"",token:"",requestData:"",availablePaymentGateways:[],elements:{applePayButtonQuerySelector:".applePayBtn"},...e};return t.merchantIdentifier="production"===t.env?"merchant.hesabe.prod":"merchant.hesabe.dec",Array.isArray(t.availablePaymentGateways)&&(t.availablePaymentGateways=t.availablePaymentGateways.map(e=>{const t=parseInt(e,10);return isNaN(t)?e:t})),t.sessionId=t.sessionId||this.#o(),t}#n(){return"production"===this.#e.env?"https://api.hesabe.com":"https://dev-paymentapi.hesabe.com"}#o(){return`${Date.now()}${Math.random().toString(36).substr(2,9)}`}#i(){const e={token:"Token is required",requestData:"Request data is required",amount:"Amount is required",availablePaymentGateways:"Available payment gateways are required",env:"Environment is required"};for(const[t,a]of Object.entries(e))if(!this.#e[t]||Array.isArray(this.#e[t])&&0===this.#e[t].length)throw new Error(`[HesabeApplePay] ${a}`)}#s(){this.#r().then(()=>{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.#l()):this.#l()})}#r(){return new Promise(e=>{if(window.ApplePaySession)return void e();const t=document.querySelector('script[src*="apple-pay-sdk.js"]');if(t)return void(t.onload=e);const a=document.createElement("script");a.src="https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js",a.onload=e,a.onerror=()=>{this.#p("Failed to load Apple Pay SDK"),e()},(document.head||document.body||document.documentElement).appendChild(a)})}#l(){window.ApplePaySession?this.#c()?this.#d():this.#p("Apple Pay not supported or not enabled for merchant"):this.#p("ApplePaySession not available in this browser")}#c(){return window.ApplePaySession&&this.#e.merchantIdentifier&&e.APPLE_PAYMENT_METHOD_IDS.some(e=>this.#e.availablePaymentGateways.includes(e))}async#d(){try{const e=await ApplePaySession.canMakePaymentsWithActiveCard(this.#e.merchantIdentifier);if(console.log(e),!e)return void this.#p("Apple Pay available in browser, but merchant not activated for domain");this.#y(),this.#p("Apple Pay initialized successfully")}catch(e){this.#p("Apple Pay initialization failed:",e)}}#h(t){const a={countryCode:this.#e.countryCode,currencyCode:this.#e.currencyCode,total:{label:this.#e.merchantCode||"Payment",type:"final",amount:this.#e.amount}};return Object.keys(e.AP_DEFAULT_CARD).forEach(t=>{a[t]=e.AP_DEFAULT_CARD[t]}),11===t&&(a.merchantCapabilities=["supports3DS","supportsDebit"]),12===t&&(a.merchantCapabilities=["supports3DS","supportsCredit"]),11!==t&&12!==t||(a.supportedCountries=["KW"]),a}async#P(e){const t=this.#h(e),a=new ApplePaySession(5,t);a.onvalidatemerchant=async t=>{this.#p("Validating merchant...");try{const n=this.#u(t.validationURL,e),i=await fetch(n);if(!i.ok)throw new Error(`Validation failed: ${i.status}`);const o=await i.json();a.completeMerchantValidation(o)}catch(e){this.#p("Merchant validation failed:",e),a.abort()}},a.onpaymentauthorized=t=>{this.#p("Payment authorized",t.payment),this.#A(t.payment,e,a)},a.oncancel=e=>{this.#p("Apple Pay cancelled",e)},a.begin()}#y(){document.querySelectorAll(this.#e.elements.applePayButtonQuerySelector).forEach(e=>{const t=parseInt(e.dataset.paymenttype),a=t&&this.#e.availablePaymentGateways.includes(t);e.style.display=a?"inline-block":"none",e.onclick=e=>{e.preventDefault(),a?this.#P(t):this.#p("Apple Pay button not enabled for this merchant")}})}#u(e,t){const a=new URLSearchParams({u:e,token:this.#t.token,serviceId:3,payId:t});return`${this.#t.routes.appleValidation}?${a.toString()}`}#A(e,t,a){try{const n=new URLSearchParams({token:this.#t.token,paymentType:t,data:this.#e.requestData,applePaymentToken:JSON.stringify(e.token.paymentData),paymentMethod:JSON.stringify(e.token.paymentMethod),session_id:this.#e.sessionId,transactionIdentifier:(e.token.transactionIdentifier||"").toLowerCase()}),i=`${this.#t.routes.payment}?${n.toString()}`;a.completePayment(ApplePaySession.STATUS_SUCCESS),location.href=i}catch(e){this.#p("Payment processing failed:",e),a.completePayment(ApplePaySession.STATUS_FAILURE)}}#p(...e){this.#e.debug&&console.log("[HesabeApplePay]",...e)}init(){return this.#s(),this}}return"undefined"!=typeof window&&(window.HesabeApplePay=e),e});
